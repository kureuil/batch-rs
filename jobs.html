<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Jobs - Batch Guide</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="User guide for the batch-rs library.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="batch.html">Batch</a></li><li><a href="concepts.html"><strong aria-hidden="true">1.</strong> Concepts</a></li><li><a href="jobs.html" class="active"><strong aria-hidden="true">2.</strong> Jobs</a></li><li><a href="rabbitmq/index.html"><strong aria-hidden="true">3.</strong> RabbitMQ</a></li><li><ol class="section"><li><a href="rabbitmq/getting-started.html"><strong aria-hidden="true">3.1.</strong> Getting Started</a></li><li><a href="rabbitmq/exchanges.html"><strong aria-hidden="true">3.2.</strong> Exchanges</a></li><li><a href="rabbitmq/queues.html"><strong aria-hidden="true">3.3.</strong> Queues</a></li></ol></li><li><a href="worker/index.html"><strong aria-hidden="true">4.</strong> Worker</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Batch Guide</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#jobs" id="jobs"><h1>Jobs</h1></a>
<a class="header" href="#declaring-a-job" id="declaring-a-job"><h2>Declaring a job</h2></a>
<p>The simplest way to declare a job is to create a function, and then annotate it with Batch's <a href="https://docs.rs/batch/0.2/index.html"><code>job</code></a> procedural macro:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
extern crate batch;

use batch::job;

#[job(name = &quot;batch-example.say-hello&quot;)]
fn say_hello(name: String) {
    println!(&quot;Hello {}!&quot;, name);
}
#}</code></pre></pre>
<a class="header" href="#return-value-of-a-job" id="return-value-of-a-job"><h2>Return value of a job</h2></a>
<p>As of today, the <a href="https://docs.rs/batch/0.2/index.html"><code>job</code></a> macro only supports two types of return values:</p>
<ul>
<li>either the function return a unit value (the <code>()</code> type);</li>
<li>either the function return a value that implements the <a href="https://docs.rs/futures/0.1/futures/future/trait.IntoFuture.html"><code>IntoFuture</code></a> trait (amongst others, it is implemented for both <code>Future</code> and <code>Result</code>)</li>
</ul>
<p>The macro not being capable of determining whether the function complies with the above requirements means that if you made a mistake, the compiler will error and the message might not be the clearest, so keep that in mind if you encounter a compile error on one of your job.</p>
<a class="header" href="#injecting-external-values" id="injecting-external-values"><h2>Injecting external values</h2></a>
<p>More often than not, your job will need values that can't or shouldn't be transfered in their message payload. For example, you might need a connection handle to your database, or a mail API client instance, or even the contents of a configuration file. To solve this problem, Batch allow you to mark arguments as <em>&quot;injected&quot;</em>. This is done by using the <code>inject</code> parameter of the <code>job</code> attribute:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
extern crate batch;

use batch::job;
#
# struct UserRepository;
# struct Mailer;

#[job(name = &quot;batch-example.send-hello&quot;, inject = [ repository, mailer ])]
fn send_hello(user_id: i32, repository: UserRepository, mailer: Mailer) {
    # drop(user_id);
    # drop(repository);
    # drop(mailer);
    // ...
}
#}</code></pre></pre>
<p>In the example above, Batch will only put the <code>user_id</code> parameter in the underlying structure, and will fetch the values for the <code>repository</code> and the <code>mailer</code> values when performing the job. These values are registered on the executor of the job which more often than not will be Batch's own <a href="./worker/index.html"><code>Worker</code></a>.</p>
<a class="header" href="#configuring-the-job" id="configuring-the-job"><h2>Configuring the job</h2></a>
<a class="header" href="#changing-the-number-of-retries" id="changing-the-number-of-retries"><h3>Changing the number of retries</h3></a>
<p>By default, a job will be tried 25 times before being declared failed and dropped into a dead-letter queue. This gives you plenty of time to fix your job's implementation. If you wish to change this number, you can do so by using the <code>retries</code> parameter of the job procedural macro:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
extern crate batch;

use batch::job;

#[job(name = &quot;batch-example.send-hello&quot;, retries = 10)]
fn send_hello(to: String) {
    println!(&quot;Hello {}&quot;, to);
}

#[job(name = &quot;batch-example.send-goodbye&quot;, retries = 50)]
fn send_goodbye(to: String) {
    println!(&quot;Goodbye {}&quot;, to);
}
#}</code></pre></pre>
<a class="header" href="#changing-the-timeout-for-the-jobs-execution" id="changing-the-timeout-for-the-jobs-execution"><h3>Changing the timeout for the job's execution</h3></a>
<p>By default, a job is given 30 minutes to complete. If you wish to change this number, you can do so by using the <code>timeout</code> parameter of the <code>job</code> procedural macro with the number of seconds the job should be allowed to run:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
extern crate batch;

use batch::job;

// This job will have 1 minute to complete.
#[job(name = &quot;batch-example.send-hello&quot;, timeout = &quot;1minute&quot;)]
fn send_hello(to: String) {
    println!(&quot;Hello {}&quot;, to);
}

// This job will have 3 hours and 30 minutes to complete.
#[job(name = &quot;batch-example.send-goodbye&quot;, timeout = &quot;3hours 30mins&quot;)]
fn send_goodbye(to: String) {
    println!(&quot;Goodbye {}&quot;, to);
}
#}</code></pre></pre>
<p>The timeout parser supports the given suffixes:</p>
<ul>
<li><code>nsec</code>, <code>ns</code> <em>-- microseconds</em></li>
<li><code>usec</code>, <code>us</code> <em>-- microseconds</em></li>
<li><code>msec</code>, <code>ms</code> <em>-- milliseconds</em></li>
<li><code>seconds</code>, <code>second</code>, <code>sec</code>, <code>s</code></li>
<li><code>minutes</code>, <code>minute</code>, <code>min</code>, <code>m</code></li>
<li><code>hours</code>, <code>hour</code>, <code>hr</code>, <code>h</code></li>
<li><code>days</code>, <code>day</code>, <code>d</code></li>
<li><code>weeks</code>, <code>week</code>, <code>w</code></li>
<li><code>months</code>, <code>month</code>, <code>M</code> <em>-- defined as 30.44 days</em></li>
<li><code>years</code>, <code>year</code>, <code>y</code> <em>-- defined as 365.25 days</em></li>
</ul>
<a class="header" href="#changing-the-job-priority" id="changing-the-job-priority"><h3>Changing the job priority</h3></a>
<p>By default, a job is assigned the <code>Normal</code> priority. If you wish to change this, you can use the <code>priority</code> parameter of the <code>job</code> procedural macro with one of <code>trivial</code>, <code>low</code>, <code>normal</code>, <code>high</code>, <code>critical</code>:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
extern crate batch;

use batch::job;

// This job will be assigned the `low` priority.
#[job(name = &quot;batch-example.send-hello&quot;, priority = low)]
fn send_hello(to: String) {
    println!(&quot;Hello {}&quot;, to);
}

// This job will be assigned the `critical` priority.
#[job(name = &quot;batch-example.send-goodbye&quot;, priority = critical)]
fn send_goodbye(to: String) {
    println!(&quot;Goodbye {}&quot;, to);
}
#}</code></pre></pre>
<hr />
<a class="header" href="#under-the-hood" id="under-the-hood"><h2>Under the hood</h2></a>
<p>Annotating a function with the <a href="https://docs.rs/batch/0.2/index.html"><code>job</code></a> procedural macro will do two things:</p>
<ul>
<li>Create a new structure deriving Serde's <a href="https://docs.serde.rs/serde/trait.Serialize.html"><code>Serialize</code></a> &amp; <a href="https://docs.serde.rs/serde/trait.Deserialize.html"><code>Deserialize</code></a> traits, that stores all of the <em>non-provided</em> (see below) function arguments. This implies that all of the arguments must also implement Serde's <a href="https://docs.serde.rs/serde/trait.Serialize.html"><code>Serialize</code></a> &amp; <a href="https://docs.serde.rs/serde/trait.Deserialize.html"><code>Deserialize</code></a> traits. More importantly, this new structure also implements Batch's <a href="https://docs.rs/batch/0.2/index.html"><code>Job</code></a> trait.</li>
<li>Change the annotated function to return an instance of the newly defined structure (see previous bullet point), allowing for easy scheduling of the job.</li>
</ul>
<a class="header" href="#get-or-set-the-underlying-struct-of-a-job" id="get-or-set-the-underlying-struct-of-a-job"><h2>Get or set the underlying struct of a job</h2></a>
<p>When invoked, <a href="https://docs.rs/batch/0.2/index.html"><code>job</code></a> procedural macro will generate a new structure declaration containing the arguments for the job, and implementing the <a href="https://docs.rs/batch/0.2/index.html"><code>Job</code></a> trait. The name of this structure is the same as the function is comes from. This is made possible by the fact that in Rust, structures and functions don't share the same namespace:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
extern crate batch;

use batch::job;

#[job(name = &quot;batch-example.say-hello&quot;)]
fn say_hello(name: String) {
    // ...
}

// Would generate code roughly equivalent to:

# mod generated_do_not_copy_paste_this_please {
struct say_hello {
    name: String
}
# }
#}</code></pre></pre>
<p>Hopefully, this simple naming scheme should not conflict with already existing code. If you ever happen to be in this situation, Batch allows you to set the name of the structure that will be generated, by using the <code>wrapper</code> parameter:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
extern crate batch;

use batch::job;

#[job(name = &quot;batch-example.say-hello&quot;, wrapper = MySuperAwesomeJob)]
fn say_hello(name: String) {
    // ...
}

// Would generate code roughly equivalent to:

# mod generated_do_not_copy_paste_this_please {
struct MySuperAwesomeJob {
    name: String
}
# }
#}</code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="concepts.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="rabbitmq/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="concepts.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="rabbitmq/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
